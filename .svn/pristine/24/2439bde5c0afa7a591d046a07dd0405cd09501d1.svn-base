/***************************************************************************************************************
 * @file           : can_pkt_bms_vcu.h
 * @brief          : Modbatt CAN packet structures
 ***************************************************************************************************************
 *
 * Copyright (c) 2023 Modular Battery Technologies, Inc
 *
 **************************************************************************************************************/
#ifndef INC_CAN_FRM_VCU_H_
#define INC_CAN_FRM_VCU_H_
/*
                                          =====================
                                          CAN PACKET STRUCTURES
                                          =====================
*/


typedef struct {                                // 0x400(was 0xC1BF35B) VCU_COMMAND - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t vcu_contactor_ctrl             : 2;  // 00-01  1          0        0       3
  uint32_t vcu_cell_balance_ctrl          : 2;  // 02-03  1          0        0       3
  uint32_t vcu_hv_bus_actv_iso_en         : 2;  // 04-05  1          0        0       3
  uint32_t UNUSED_06_31                   : 24;  // 06-07
  uint32_t UNUSED_32_63                   : 32; // 32-63
}CANFRM_0x400_VCU_COMMAND;


typedef struct {                                // 0x410 BMS_STATE - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t bms_state                      : 2;  // 00-01                                                              BMS State 00=OFF (command all module relays (both mechanical & FET) off, 01=STDBY (command mechanical ON, FET OFF on all modules), 10=PRCHG ( command mechanical ON for all modules, FET on for one module), 11=ON (command both relays ON for all modules)
  uint32_t bms_soh                        : 8;  // 02-09
  uint32_t bms_status                     : 2;  // 10-11                                                              BMS Status 00=off, 01=pack full, 10 = pack empty, 11=pack normal
  uint32_t bms_cell_balance_status        : 1;  // 12                                                                 Flag to indicate whether cells have been balanced
  uint32_t bms_cell_balance_active        : 1;  // 13                                                                 Flag to indicate that cell balancing is in progress
  uint32_t bms_module_off                 : 1;  // 14                                                                 Flag to indicate one or more modules in a fault condition
  uint32_t UNUSED_16                      : 1;  // 15
  uint32_t bms_total_mod_cnt              : 8;  // 16-23                                                              Total number of modules in the pack
  uint32_t bms_active_mod_cnt             : 8;  // 24-31                                                              Number of active modules in the pack
  uint32_t UNUSED_31_63                   : 32; // 31-63
 }CANFRM_0x410_BMS_STATE;



 /*
  *
  * As we've been discussing,  vcu relay command to BMS are as follows:
0: OFF (command all module relays (both mechanical & FET) off)
1: STDBY (command mechanical ON, FET OFF on all modules)
2: PRCHG ( command mechanical ON for all modules, FET on for one module)
3: ON (command both relays ON for all modules).
  *
  *
  * status can be one of 4:

charge prohibited/discharge prohibited - pack not in a condition to source or receive current, for any reason, in any state, but always the case in any state except ON
charge allowed/discharge prohibited - pack is empty, state is ON
charge allowed/discharge allowed - pack in a normal state, state is ON

charge prohibited/discharge allowed - pack is full, state is ON
  */

typedef struct {                                // 0x421 (was 0xCF090F3) BMS_DATA_1 - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t UNUSED_00_31                   : 32; // 00-31
  uint32_t bms_pack_voltage               : 16; // 32-47  0.05       0        0       3276.75       Volts             The voltage level of the pack
  uint32_t bms_pack_current               : 16; // 48-63  0.05       -1600    -1600   1676.75       Amps              The current in or out of the pack. A positive value represents current into (charging) the energy storage system.  A negative value represents current out of (discharging) the energy storage system.
 }CANFRM_0x421_BMS_DATA_1;


typedef struct {                                // 0x422 (was 0xCF091F3) BMS_DATA_2 - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t bms_soc                        : 16; // 00-15  0.0015625  0        0       102.3984375   %                 State of charge
  uint32_t bms_high_cell_volt             : 16; // 16-31  0.001      0        0       65.535        Volts             Highest cell voltage reported by any cell
  uint32_t bms_low_cell_volt              : 16; // 32-47  0.001      0        0       65.535        Volts             Lowest cell voltage reported by any cell
  uint32_t bms_avg_cell_volt              : 16; // 32-39  0.001      0        0       65.535        Volts             The average cell voltage
 }CANFRM_0x422_BMS_DATA_2;

typedef struct {                                // 0x423 (was 0xCF092F3) BMS_DATA_3 - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t bms_high_cell_temp             : 16; // 00-15  0.03125    -273     0       1774.96875    Degrees Celcius   Highest cell temperature reported by any cell
  uint32_t bms_low_cell_temp              : 16; // 16-31  0.03125    -273     0       1774.96875    Degrees Celcius   Lowest cell temperature reported by any cell
  uint32_t bms_avg_cell_temp              : 16; // 32-47  0.03125    -273     0       1774.96875    Degrees Celcius   The average temperature level of all cells
  uint32_t UNUSED_48_63                   : 16; // 48-63
 }CANFRM_0x423_BMS_DATA_3;


 typedef struct {                                // 0x425 (was 0xCF094F3) BMS_DATA_5 - 8 bytes
                                                 // Bits   Factor     Offset   Min     Max           Unit
   uint32_t bms_dischage_limit             : 16; // 00-15  0.05       -1600    -1600   1676.75       Amps             The maximum permissible current flow out of the High Voltage Energy Storage System
   uint32_t bms_charge_limit               : 16; // 16-31  0.05       -1600    -1600   1676.75       Amps             The maximum permissible current flow in to the High Voltage Energy Storage System
   uint32_t bms_charge_end_voltage_limit   : 16; // 32-47  0.05       0        0       3276.75       Volts            The maximum permissable voltage at end of charge
   uint32_t UNUSED_48_63                   : 16; // 48-63
  }CANFRM_0x425_BMS_DATA_5;



typedef struct {                                // 0x428 (was 0xCF10AF3) BMS_DATA_8 - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t bms_max_volt_mod               : 8;  // 00-07  1          0        0       255                             Module number with highest cell voltage
  uint32_t bms_max_volt_cell              : 8;  // 08-15  1          0        0       255                             The number of the cell with highest voltage, within the module
  uint32_t bms_min_volt_mod               : 8;  // 16-23  1          0        0       255                             Module number with lowest cell voltage
  uint32_t bms_min_volt_cell              : 8;  // 24-31  1          0        0       255                             The number of the cell with lowest voltage,  within the module
  uint32_t UNUSED_32_63                   : 32; // 48-63
 }CANFRM_0x428_BMS_DATA_8;


typedef struct {                                // 0x429 (was 0xCF10BF3) BMS_DATA_9 - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t bms_max_temp_mod               : 8;  // 00-07  1          0        0       255                             Module number with highest cell temperature
  uint32_t bms_max_temp_cell              : 8;  // 08-15  1          0        0       255                             The number of the cell with highest temperature, within the module
  uint32_t bms_min_temp_mod               : 8;  // 16-23  1          0        0       255                             Module number with lowest cell temperature
  uint32_t bms_min_temp_cell              : 8;  // 24-31  1          0        0       255                             The number of the cell with lowest temperature, within the module
  uint32_t UNUSED_32_63                   : 32; // 32-63
 }CANFRM_0x429_BMS_DATA_9;


typedef struct {                                // 0x430 (was 0xCF10CF3) BMS_DATA_10 - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t bms_hv_bus_actv_iso            : 16; // 00-15  0.01       0        0       6553.5        Ohm/V             High-Voltage Bus Active Isolation Test Results
  uint32_t UNUSED_16_31                   : 16; // 16-31
  uint32_t UNUSED_32_63                   : 32; // 32-63
 }CANFRM_0x430_BMS_DATA_10;


 /*
typedef struct {                                // 0x425 (was 0xCF094F3) BMS_DATA_5 - 8 bytes
                                                // Bits   Factor     Offset   Min     Max           Unit
  uint32_t bms_dischage_limit_8082        : 16; // 00-15  0.05       -1600    -1600   1676.75       Amps
  uint32_t bms_charge_limit_8083          : 16; // 16-31  0.05       -1600    -1600   1676.75       Amps
  uint32_t UNUSED_32_63                   : 32; // 32-63
 }CANFRM_0x425_BMS_DATA_5; //CANFRM_0xCF094F3_BMS_DATA_5;
*/


 /*
 typedef struct {                                // 0x411 (was 0xCFF01F3) BMS_STATE - 8 bytes
                                                 // Bits   Factor     Offset   Min     Max           Unit
   uint32_t UNUSED_00_03                   : 4;  // 00-03
   uint32_t bms_state                      : 4;  // 04-07
   uint32_t UNUSED_08_31                   : 24; // 16-31
   uint32_t UNUSED_32_63                   : 32; // 32-63
  }CANFRM_0x411_BMS_STATE; //CANFRM_0xCFF01F3_BMS_STATE;
 */

  /*
  typedef struct {                                // 0x412 (was 0xCF096F3) BMS_S1 - 8 bytes
                                                  // Bits   Factor     Offset   Min     Max           Unit
    uint32_t bms_cont_pos_status_8091       : 2;  // 00-01                                                             // Not applicable
    uint32_t bms_cont_neg_status_8092       : 2;  // 02-03                                                             // Not applicable
    uint32_t bms_disconnect_warn_8093       : 4;  // 04-07                                                             // Not applicable
    uint32_t bms_prechg_rly_status_8094     : 2;  // 08-09                                                             // Not applicable
    uint32_t UNUSED_10_19                   : 10; // 10-19
    uint32_t bms_hvil_status_8098           : 2;  // 20-21
    uint32_t UNUSED_22_27                   : 6;  // 22-27
    uint32_t bms_cell_balance_status_8101   : 2;  // 28-29
    uint32_t bms_cell_balance_active_8102   : 2;  // 30-31
    uint32_t UNUSED_32_39                   : 8;  // 32-39
    uint32_t bms_hv_bus_status_8413         : 4;  // 40-43
    uint32_t bms_operation_status_8414      : 4;  // 44-47
    uint32_t UNUSED_48_63                   : 16; // 48-63
   }CANFRM_0x412_BMS_S1; //CANFRM_0xCF096F3_BMS_S1;
 */

  /*
  typedef struct {                                 // 0x413 (was 0x1CFC5EF3) BMS_SOH - 8 bytes
                                                   // Bits   Factor     Offset   Min     Max           Unit
    uint32_t bms_soh_8121                    : 8;  // 00-07  0.4        0        0       102           Percent
    uint32_t UNUSED_08_31                    : 24; // 08-31
    uint32_t UNUSED_32_63                    : 32; // 32-63
 }CANFRM_0x413_BMS_SOH; //CANFRM_0x1CFC5EF3_BMS_SOH;
 */

/*
typedef struct {                                 // 0x18FD1549 BCH1 - 8 bytes
                                                 // Bits   Factor     Offset   Min     Max           Unit
  uint32_t UNUSED_00_03                    : 4;  // 00-03
  uint32_t vcu_chrgr1_powerline_state_4991 : 2;  // 04-05
  uint32_t UNUSED_06_31                    : 26; // 06-31
  uint32_t UNUSED_32_63                    : 32; // 32-63
 }CANFRM_0x18FD1549_BCH1;
*/


/*
typedef struct {                                // 0x200 BMS_TEMPLATE - 8 bytes
                                                // Bits   Factor  Offset   Min     Max       Unit
  uint32_t  : 1;  // 00
  uint32_t  : 1   // 01
  uint32_t  : 1;  // 02
  uint32_t  : 1;  // 03
  uint32_t  : 1;  // 04
  uint32_t  : 1;  // 05
  uint32_t  : 1;  // 06
  uint32_t  : 1;  // 07
  uint32_t  : 1;  // 08
  uint32_t  : 1;  // 09
  uint32_t  : 1;  // 10
  uint32_t  : 1;  // 11
  uint32_t  : 1;  // 12
  uint32_t  : 1;  // 13
  uint32_t  : 1;  // 14
  uint32_t  : 1;  // 15
  uint32_t  : 1;  // 16
  uint32_t  : 1;  // 17
  uint32_t  : 1;  // 18
  uint32_t  : 1;  // 19
  uint32_t  : 1;  // 20
  uint32_t  : 1;  // 21
  uint32_t  : 1;  // 22
  uint32_t  : 1;  // 23
  uint32_t  : 1;  // 24
  uint32_t  : 1;  // 25
  uint32_t  : 1;  // 26
  uint32_t  : 1;  // 27
  uint32_t  : 1;  // 28
  uint32_t  : 1;  // 29
  uint32_t  : 1;  // 30
  uint32_t  : 1;  // 31
  uint32_t  : 1;  // 32
  uint32_t  : 1;  // 33
  uint32_t  : 1;  // 34
  uint32_t  : 1;  // 35
  uint32_t  : 1;  // 36
  uint32_t  : 1;  // 37
  uint32_t  : 1;  // 38
  uint32_t  : 1;  // 39
  uint32_t  : 1;  // 40
  uint32_t  : 1;  // 41
  uint32_t  : 1;  // 42
  uint32_t  : 1;  // 43
  uint32_t  : 1;  // 44
  uint32_t  : 1;  // 45
  uint32_t  : 1;  // 46
  uint32_t  : 1;  // 47
  uint32_t  : 1;  // 48
  uint32_t  : 1;  // 49
  uint32_t  : 1;  // 50
  uint32_t  : 1;  // 51
  uint32_t  : 1;  // 52
  uint32_t  : 1;  // 53
  uint32_t  : 1;  // 54
  uint32_t  : 1;  // 55
  uint32_t  : 1;  // 56
  uint32_t  : 1;  // 57
  uint32_t  : 1;  // 58
  uint32_t  : 1;  // 59
  uint32_t  : 1;  // 60
  uint32_t  : 1;  // 60
  uint32_t  : 1;  // 61
  uint32_t  : 1;  // 62
  uint32_t  : 1;  // 63
}CANFRM_0x200_BMS_TEMPLATE;
*/


#endif /* INC_CAN_FRM_VCU_H_ */
